version: 2
jobs:
  build:
    machine:
      docker_layer_caching: true
    environment:
      LIBMEMC_VERSION: 1.0.18-10
      IGBINARY_VERSION: 2.0.7-1
      MSGPACK_VERSION: 2.0.2-7
      PACKAGE_VCS_URL: https://github.com/aursu/rpmbuild-php-memcached
    steps:
      - run:
          name: Upgrade Docker CE
          command: |
            sudo apt-get update
            sudo apt-get install docker-ce=18.03.1~ce-0~ubuntu
      - run:
          name: Upgrade Docker Compose
          command: |
            sudo curl -L https://github.com/docker/compose/releases/download/1.21.2/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
      - run:
          name: Create Build User/Group
          command: |
            if getent group centos; then
              sudo groupmod -o -g 48 centos
            else
              sudo groupadd -o -g 48 centos
            fi

            if getent passwd centos; then
              sudo usermod -o -u 48 -g centos centos
            else
              sudo useradd -o -u 48 -g centos -M -d /var/www/html centos
            fi
      - checkout
      - run:
          name: Git submodules sync
          command: |
            git submodule sync
            git submodule update --init
      - run:
          name: Start docker services for rpmbuild
          command: |
            docker-compose -f rpmbuild/docker-compose.yml pull
            docker-compose -f rpmbuild/docker-compose.yml up -d
          background: true
          no_output_timeout: 2h
      - restore_cache:
          keys:
            - rpm-cache-v7-{{ checksum "requirements.txt" }}-{{ checksum "SPECS/php-pecl-memcached.spec" }}
            - rpm-cache-v7-{{ checksum "requirements.txt" }}-
            - rpm-cache-v7-
      - run:
          name: Restore Repository
          command: |
            sleep 30
            if [ -d ~/el6/RPMS ]; then
              sudo chown -R centos:centos ~/el6/RPMS
              docker cp -a ~/el6/RPMS rpmbuild_webrepo_1:/home/centos-6/rpmbuild/
            fi
            if [ -d ~/el7/RPMS ]; then
              sudo chown -R centos:centos ~/el7/RPMS
              docker cp -a ~/el7/RPMS rpmbuild_webrepo_1:/home/centos-7/rpmbuild/
            fi
      - run:
          name: Checkout libmemcached
          command: |
            git clone https://github.com/aursu/rpmbuild-libmemcached.git
            cd rpmbuild-libmemcached
            git checkout $LIBMEMC_VERSION
      - run:
          name: Build libmemcached
          command: |
            docker run -ti --rm --net buildnet -u root aursu/rpmbuild:7-build \
            yum -q list --disablerepo=* --enablerepo custom libmemcached-devel | grep -q $LIBMEMC_VERSION ||
            {
              docker pull aursu/libmemcbuild:el7
              docker-compose -f rpmbuild-libmemcached/docker-compose.yml up centos7libmemcbuild
            }
            docker run -ti --rm --net buildnet -u root aursu/rpmbuild:6-build \
            yum -q list --disablerepo=* --enablerepo custom libmemcached-devel | grep -q $LIBMEMC_VERSION ||
            {
              docker pull aursu/libmemcbuild:el6
              docker-compose -f rpmbuild-libmemcached/docker-compose.yml up centos6libmemcbuild
            }
      - run:
          name: Checkout PHP igbinary pecl module
          command: |
            git clone https://github.com/aursu/rpmbuild-php-igbinary.git
            cd rpmbuild-php-igbinary
            git checkout $IGBINARY_VERSION
      - run:
          name: Build PHP igbinary pecl module
          command: |
            docker run -ti --rm --net buildnet -u root aursu/rpmbuild:7-build \
            yum -q list --disablerepo=* --enablerepo custom php-pecl-igbinary-devel | grep -q $IGBINARY_VERSION ||
            {
              docker pull aursu/peclbuild:7-igbinary
              docker-compose -f rpmbuild-php-igbinary/docker-compose.yml up centos7igbinarybuild
            }
            docker run -ti --rm --net buildnet -u root aursu/rpmbuild:6-build \
            yum -q list --disablerepo=* --enablerepo custom php-pecl-igbinary-devel | grep -q $IGBINARY_VERSION ||
            {
              docker pull aursu/peclbuild:6-igbinary
              docker-compose -f rpmbuild-php-igbinary/docker-compose.yml up centos6igbinarybuild
            }
      - run:
          name: Checkout PHP msgpack pecl module
          command: |
            git clone https://github.com/aursu/rpmbuild-php-msgpack.git
            cd rpmbuild-php-msgpack
            git checkout $MSGPACK_VERSION
      - run:
          name: Build PHP msgpack pecl module
          command: |
            docker run -ti --rm --net buildnet -u root aursu/rpmbuild:7-build \
            yum -q list --disablerepo=* --enablerepo custom php-pecl-msgpack-devel | grep -q $MSGPACK_VERSION ||
            {
              docker pull aursu/peclbuild:7-msgpack
              docker-compose -f rpmbuild-php-msgpack/docker-compose.yml up centos7msgpackbuild
            }
            docker run -ti --rm --net buildnet -u root aursu/rpmbuild:6-build \
            yum -q list --disablerepo=* --enablerepo custom php-pecl-msgpack-devel | grep -q $MSGPACK_VERSION ||
            {
              docker pull aursu/peclbuild:6-msgpack
              docker-compose -f rpmbuild-php-msgpack/docker-compose.yml up centos6msgpackbuild
            }
      - run:
          name: Build Docker images
          command: |
            sleep 30
            docker-compose build --no-cache
      - run:
          name: Build RPM packages
          command: docker-compose up
      - save_cache:
          key: rpm-cache-v7-{{ checksum "requirements.txt" }}-{{ checksum "SPECS/php-pecl-memcached.spec" }}
          paths:
            - ~/el6/RPMS
            - ~/el7/RPMS
      - run:
          name: Copy RPM packages
          command: |
            sudo rm -rf ~/el6 ~/el7
            mkdir -p ~/el6 ~/el7
            docker cp rpmbuild_webrepo_1:/home/centos-6/rpmbuild/RPMS ~/el6/
            docker cp rpmbuild_webrepo_1:/home/centos-7/rpmbuild/RPMS ~/el7/
            sudo chown -R centos:centos ~/el6/RPMS ~/el7/RPMS
      - run:
          name: Upload RPM packages into Bintray
          command: |
            docker-compose -f rpmbuild/docker-compose.bintray.yml pull
            docker-compose -f rpmbuild/docker-compose.bintray.yml run --rm \
              -e BINTRAY_USER=$BINTRAY_USER \
              -e BINTRAY_API_KEY=$BINTRAY_API_KEY \
              -e BINTRAY_REPO=$BINTRAY_REPO \
              -e PACKAGE_VCS_URL=$PACKAGE_VCS_URL centos7bintray
            docker-compose -f rpmbuild/docker-compose.bintray.yml run --rm \
              -e BINTRAY_USER=$BINTRAY_USER \
              -e BINTRAY_API_KEY=$BINTRAY_API_KEY \
              -e BINTRAY_REPO=$BINTRAY_REPO \
              -e PACKAGE_VCS_URL=$PACKAGE_VCS_URL centos6bintray
      - run:
          name: Upload Docker images
          command: |
            docker login -u $DOCKER_USER -p $DOCKER_PASS
            sleep 30
            docker push aursu/peclbuild:7-memcached-base
            docker push aursu/peclbuild:6-memcached-base
            docker push aursu/peclbuild:7-memcached
            docker push aursu/peclbuild:6-memcached
      - store_artifacts:
          path: ~/el6/RPMS
      - store_artifacts:
          path: ~/el7/RPMS
  build5:
    machine:
      docker_layer_caching: true
    environment:
      LIBMEMC_VERSION: 1.0.18-10
      IGBINARY_VERSION: 2.0.7-1
      MSGPACK_VERSION: 0.5.7-4
      BINTRAY_REPO: php5custom
      PACKAGE_VCS_URL: https://github.com/aursu/rpmbuild-php-memcached
    steps:
      - run:
          name: Upgrade Docker CE
          command: |
            sudo apt-get update
            sudo apt-get install docker-ce=18.03.1~ce-0~ubuntu
      - run:
          name: Upgrade Docker Compose
          command: |
            sudo curl -L https://github.com/docker/compose/releases/download/1.21.2/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
      - run:
          name: Create Build User/Group
          command: |
            if getent group centos; then
              sudo groupmod -o -g 48 centos
            else
              sudo groupadd -o -g 48 centos
            fi

            if getent passwd centos; then
              sudo usermod -o -u 48 -g centos centos
            else
              sudo useradd -o -u 48 -g centos -M -d /var/www/html centos
            fi
      - checkout
      - run:
          name: Git submodules sync
          command: |
            git submodule sync
            git submodule update --init
      - run:
          name: Start docker services for rpmbuild
          command: |
            docker-compose -f rpmbuild/docker-compose.yml pull
            docker-compose -f rpmbuild/docker-compose.yml up -d
          background: true
          no_output_timeout: 2h
      - restore_cache:
          keys:
            - rpm-cache-v5-{{ checksum "requirements.txt" }}-{{ checksum "SPECS/php-pecl-memcached.spec" }}
            - rpm-cache-v5-{{ checksum "requirements.txt" }}-
            - rpm-cache-v5-
      - run:
          name: Restore Repository
          command: |
            sleep 30
            if [ -d ~/php5/el6/RPMS ]; then
              sudo chown -R centos:centos ~/php5/el6/RPMS
              docker cp -a ~/php5/el6/RPMS rpmbuild_webrepo_1:/home/centos-6/rpmbuild/
            fi
            if [ -d ~/php5/el7/RPMS ]; then
              sudo chown -R centos:centos ~/php5/el7/RPMS
              docker cp -a ~/php5/el7/RPMS rpmbuild_webrepo_1:/home/centos-7/rpmbuild/
            fi
      - run:
          name: Checkout libmemcached
          command: |
            git clone https://github.com/aursu/rpmbuild-libmemcached.git
            cd rpmbuild-libmemcached
            git checkout $LIBMEMC_VERSION
      - run:
          name: Build libmemcached
          command: |
            docker run -ti --rm --net buildnet -u root aursu/rpmbuild:7-build \
            yum -q list --disablerepo=* --enablerepo custom libmemcached-devel | grep -q $LIBMEMC_VERSION ||
            {
              docker pull aursu/libmemcbuild:el7
              docker-compose -f rpmbuild-libmemcached/docker-compose.yml up centos7libmemcbuild
            }
            docker run -ti --rm --net buildnet -u root aursu/rpmbuild:6-build \
            yum -q list --disablerepo=* --enablerepo custom libmemcached-devel | grep -q $LIBMEMC_VERSION ||
            {
              docker pull aursu/libmemcbuild:el6
              docker-compose -f rpmbuild-libmemcached/docker-compose.yml up centos6libmemcbuild
            }
      - run:
          name: Checkout PHP igbinary pecl module
          command: |
            git clone https://github.com/aursu/rpmbuild-php-igbinary.git
            cd rpmbuild-php-igbinary
            git checkout $PHP_APCU_VERSION
      - run:
          name: Build PHP igbinary pecl module
          command: |
            docker run -ti --rm --net buildnet -u root aursu/rpmbuild:7-build \
            yum -q list --disablerepo=* --enablerepo custom php-pecl-igbinary-devel | grep -q $IGBINARY_VERSION ||
            {
              docker pull aursu/peclbuild:7-igbinary-php5
              docker-compose -f rpmbuild-php-igbinary/docker-compose.php5.yml up centos7igbinarybuildphp5
            }
            docker run -ti --rm --net buildnet -u root aursu/rpmbuild:6-build \
            yum -q list --disablerepo=* --enablerepo custom php-pecl-igbinary-devel | grep -q $IGBINARY_VERSION ||
            {
              docker pull aursu/peclbuild:6-igbinary-php5
              docker-compose -f rpmbuild-php-igbinary/docker-compose.php5.yml up centos6igbinarybuildphp5
            }
      - run:
          name: Checkout PHP msgpack pecl module
          command: |
            git clone https://github.com/aursu/rpmbuild-php-msgpack.git
            cd rpmbuild-php-msgpack
            git checkout $MSGPACK_VERSION
      - run:
          name: Build PHP msgpack pecl module
          command: |
            docker run -ti --rm --net buildnet -u root aursu/rpmbuild:7-build \
            yum -q list --disablerepo=* --enablerepo custom php-pecl-msgpack-devel | grep -q $MSGPACK_VERSION ||
            {
              docker pull aursu/peclbuild:7-msgpack-php5
              docker-compose -f rpmbuild-php-msgpack/docker-compose.php5.yml up centos7msgpackbuildphp5
            }
            docker run -ti --rm --net buildnet -u root aursu/rpmbuild:6-build \
            yum -q list --disablerepo=* --enablerepo custom php-pecl-msgpack-devel | grep -q $MSGPACK_VERSION ||
            {
              docker pull aursu/peclbuild:6-msgpack-php5
              docker-compose -f rpmbuild-php-msgpack/docker-compose.php5.yml up centos6msgpackbuildphp5
            }
      - run:
          name: Build Docker images (PHP 5)
          command: |
            sleep 30
            docker-compose -f docker-compose.php5.yml build --no-cache
      - run:
          name: Build RPM packages (PHP 5)
          command: docker-compose -f docker-compose.php5.yml up
      - run:
          name: Upload RPM packages into Bintray
          command: |
            docker-compose -f rpmbuild/docker-compose.bintray.yml pull
            docker-compose -f rpmbuild/docker-compose.bintray.yml run --rm \
              -e BINTRAY_USER=$BINTRAY_USER \
              -e BINTRAY_API_KEY=$BINTRAY_API_KEY \
              -e BINTRAY_REPO=$BINTRAY_REPO \
              -e PACKAGE_VCS_URL=$PACKAGE_VCS_URL centos7bintray
            docker-compose -f rpmbuild/docker-compose.bintray.yml run --rm \
              -e BINTRAY_USER=$BINTRAY_USER \
              -e BINTRAY_API_KEY=$BINTRAY_API_KEY \
              -e BINTRAY_REPO=$BINTRAY_REPO \
              -e PACKAGE_VCS_URL=$PACKAGE_VCS_URL centos6bintray
      - run:
          name: Copy RPM packages (PHP 5)
          command: |
            sudo rm -rf ~/php5
            mkdir -p ~/php5/el6 ~/php5/el7
            docker cp rpmbuild_webrepo_1:/home/centos-6/rpmbuild/RPMS ~/php5/el6/
            docker cp rpmbuild_webrepo_1:/home/centos-7/rpmbuild/RPMS ~/php5/el7/
            sudo chown -R centos:centos ~/php5/*
      - run:
          name: Upload Docker images (PHP 5)
          command: |
            docker login -u $DOCKER_USER -p $DOCKER_PASS
            sleep 30
            docker push aursu/peclbuild:7-memcached-base-php5
            docker push aursu/peclbuild:6-memcached-base-php5
            docker push aursu/peclbuild:7-memcached-php5
            docker push aursu/peclbuild:6-memcached-php5
      - save_cache:
          key: rpm-cache-v5-{{ checksum "requirements.txt" }}-{{ checksum "SPECS/php-pecl-memcached.spec" }}
          paths:
            - ~/php5
      - store_artifacts:
          path: ~/php5
workflows:
  version: 2
  memcachedbuild:
    jobs:
      - build
      - build5
